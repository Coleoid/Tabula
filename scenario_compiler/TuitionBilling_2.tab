Scenario: "ï»¿AC-20439: Tuition billing"

"Setup - create a training academy and an organization":
>use: Organization FNH Management, Curriculum FNH Management, Class Template Add Edit Workflow
Set today to "1/1/2023"
Create academy named "Testopia Academy"
Create organization named "Local Police Department"
Create program category "Training"

"Create a new program":
>use: Edit Program Workflow
Browse to page from organization "Testopia Academy"
Set program name to "Driving"
Select "Training" as category
Set program "is" active
Save

"Setup - create a training academy and an organization":
>use: Organization FNH Management, Curriculum FNH Management, Class Template Add Edit Workflow
Create class template named "Highway Pursuit" in program "Driving" for organization "Testopia Academy"
Validate Class Template named "Highway Pursuit" in program "Driving"

"Setup - Add a new class":
>use: Edit Class Workflow
Browse to page
Create Class named #name from "Highway Pursuit" starting "01/1/2023" ending #endDate
    [ Name                | End Date ]
    | Highway Pursuit 100 | 1/1/2023 |
    | Highway Pursuit 101 | 1/1/2023 |
    | Highway Pursuit 102 | 2/1/2023 |
    | Highway Pursuit 103 | 2/1/2023 |

"Setup class registrations":
>use: Add Edit Class Registration Workflow
Create class registration for "Highway Pursuit 100" to start "0" days before and end "0" days after with "10" students max
Create class registration for "Highway Pursuit 101" to start "0" days before and end "0" days after with "10" students max
Create class registration for "Highway Pursuit 102" to start "0" days before and end "0" days after with "10" students max

"Set and verify Tuitions":
>use: Class Descriptive Fields Workflow
Browse to page for class #name
Enter text #fees for "Fees"
Click button "Done"
Browse to page for class #name
Verify text for "Fees" is #fees
    [ Name                | Fees   ]
    | Highway Pursuit 100 | 101.42 |
    | Highway Pursuit 101 | 131.45 |
    | Highway Pursuit 102 | 152.55 |
    | Highway Pursuit 103 | 172.55 |

"Create people":
>use: Person FNH Management
Create person #name with academy id #id
    [ Name                  | ID ]
    | "Agmeier, Armin"      | A1 |
    | "Bradley, Blake"      | B1 |
    | "Brown, Wendell"      | B2 |
    | "Chase, Charles"      | C1 |
    | "Doo, Dewbie"         | D1 |
    | "Easley, Erwin"       | E1 |
    | "Eady, Forrest"       | E2 |
    | "Fairchild, Florence" | F1 |
    | "Johnson, Danny"      | J1 |
    | "Murphy, Sam"         | M1 |
    | "Nicholas, Jamila"    | N1 |
    | "Worthen, Jorge"      | W1 |


"Enable billing":
>use: Billing Preferences Workflow
Browse to page
Choose to track billing
Prepare to save
Click save

"Disable billing for class tuition":
>use: Billing Preferences Workflow
Browse to page
Click to edit category "Class"
Choose not to track category
Prepare to save preference
Click save preference


// -- NONE --------------------------------------------------------------

"Register person A":
>use: Register Student Workflow
Browse to page from available training list registering for "Highway Pursuit 100"
Select student "Agmeier, Armin"
Click Register

"Verify no bill was created at registration":
>use: Billing Items Export Workflow
Export all billing items
? Verify there are "0" items

"Enroll person A":
>use: Registration Management
Enroll "Agmeier, Armin" in  "Highway Pursuit 100" from registration

"Verify no bill was created at enrollment":
>use: Billing Items Export Workflow
Export all billing items
? Verify there are "0" items

"Complete class":
>use: Task Runner Workflow
Run task "AutoUpdateClassStatus"

"Verify no bill was created at enrollment":
>use: Billing Items Export Workflow
Export all billing items
? Verify there are "0" items


// -- REGISTRATION --------------------------------------------------------------

"Change billing to at registration":
>use: Billing Preferences Workflow
Browse to page
Click to edit category "Class"
Choose to track category
Choose to create billing information "At registration"
Choose to calculate billing as a variable fee
Choose "Individual" to be responsible for fees
Prepare to save preference
Click save preference

"Register Bradley, Blake":
>use: Register Student Workflow
Browse to page from available training list registering for "Highway Pursuit 100"
Select student "Bradley, Blake"
Select  "Individual" for Tuition Bill to Party
Click Register

"Verify bill was created at registration":
>use: Billing Items Export Workflow
Export all billing items
? Verify there are "1" items

"Transfer Bradley, Blake":
>use: Transfer Student Workflow
Browse to transfer registration for "Bradley, Blake" from class "Highway Pursuit 100"
Select "Highway Pursuit 101" to transfer to
Click transfer

"Verify bill was created at registration transfer":
>use: Billing Items Export Workflow
Export all billing items
? Verify there are "2" items

"Enroll Nicholas, Jamila directly in course without registration":
>use: Add Enrollment Workflow
Browse to page for "Highway Pursuit 103"
Select "Nicholas, Jamila" to enroll
Select  "Individual" for Tuition Bill to Party
Click Continue

"Verify bill was created at registration transfer":
>use: Billing Items Export Workflow
Export all billing items
? Verify there are "3" items

"Bradley, Blake":
>use: Registration Management
Enroll "Bradley, Blake" in "Highway Pursuit 101" from registration

"Verify no bill was created at enrollment":
>use: Billing Items Export Workflow
Export all billing items
? Verify there are "3" items

"Complete class":
>use: Task Runner Workflow
Run task "AutoUpdateClassStatus"

"Verify no bill was created at class completion":
>use: Billing Items Export Workflow
Export all billing items
? Verify there are "3" items

// -- ENROLLMENT --------------------------------------------------------------

"Change billing to at enrollment with flat fee":
>use: Billing Preferences Workflow
Browse to page
Click to edit category "Class"
Choose to track category
Choose to create billing information "At enrollment"
Choose to calculate billing as a flat fee
Enter "99.99" as a flat fee
Choose "Individual" to be responsible for fees
Prepare to save preference
Click save preference


"Register C":
>use: Register Student Workflow
Browse to page from available training list registering for "Highway Pursuit 100"
Select student "Chase, Charles"
Select  "Individual" for Tuition Bill to Party
Click Register

"Verify no bill was created at registration":
>use: Billing Items Export Workflow
Export all billing items
? Verify there are "3" items

"Enroll person C":
>use: Registration Management
Enroll "Chase, Charles" in "Highway Pursuit 100" from registration

"Verify bill was created at enrollment":
>use: Billing Items Export Workflow
Export all billing items
? Verify there are "4" items

"Enroll person D directly":
>use: Add Enrollment Workflow
Browse to page for "Highway Pursuit 100"
Select "Doo, Dewbie" to enroll
Select  "Individual" for Tuition Bill to Party
Click Continue

"Verify bill was created at enrollment":
>use: Billing Items Export Workflow
Export all billing items
? Verify there are "5" items

? Verify row #num
    ? Verify "Category" is "Class"
    ? Verify "Bill Created At" is #BilledAt
    ? Verify "Event / Class*" is #ClassItem
    ? Verify "Billing Item" is #ClassItem
    ? Verify "Billing Usage" is ""
    ? Verify "Usage Period Start" is ""
    ? Verify "Usage Period End" is ""
    ? Verify "For" is #Name
    ? Verify "Date" is equal to today
    ? Verify "Bill To" is #Name
    ? Verify "Amount" is #Amount
    ? Verify "Cancelled" is "N"

[ Num | Billed At    | Class Item                    | Name               | Amount ]
|   1 | Registration | Driving - Highway Pursuit 100 | "Bradley, Blake"   | 101.42 |
|   2 | Registration | Driving - Highway Pursuit 101 | "Bradley, Blake"   | 131.45 |
|   3 | Enrollment   | Driving - Highway Pursuit 103 | "Nicholas, Jamila" | 172.55 |
|   4 | Enrollment   | Driving - Highway Pursuit 100 | "Chase, Charles"   |  99.99 |
|   5 | Enrollment   | Driving - Highway Pursuit 100 | "BDoo, Dewbie"     |  99.99 |

"Complete class":
>use: Task Runner Workflow
Run task "AutoUpdateClassStatus"

"Verify no bill was created at enrollment":
>use: Billing Items Export Workflow
Export all billing items
? Verify there are "5" items

"Verify billing items are returned correctly in web service":
>use: Accounting Api Workflow
Get invoiceable items
? Verify there are "5" invoiceable items

Begin verifying invoiceable item #Num
    ? Verify invoiceable item Event is #EventName
    ? Verify invoiceable item Item is #EventName
    ? Verify invoiceable item Usage is blank
    ? Verify invoiceable item PeriodStart is null
    ? Verify invoiceable item PeriodEnd is null
    ? Verify invoiceable item BillFor is #BillName
    ? Verify invoiceable item BillTo is #BillName
    ? Verify invoiceable item BillToID is greater than zero
    ? Verify invoiceable item Amount is #Amount
    ? Verify invoiceable item CreationDate is "1/1/2023"

[ Num | Event name                    | BillName           | Amount ]
| 1   | Driving - Highway Pursuit 100 | "Bradley, Blake"   | 101.42 |
| 2   | Driving - Highway Pursuit 101 | "Bradley, Blake"   | 131.45 |
| 3   | Driving - Highway Pursuit 103 | "Nicholas, Jamila" | 172.55 |
| 4   | Driving - Highway Pursuit 100 | "Chase, Charles"   |  99.99 |
| 5   | Driving - Highway Pursuit 100 | "Doo, Dewbie"      |  99.99 |


// -- CANCELLATIONS -----------------------------------------------------------
"Delete an enrollment":
>use: Student List Workflow
Browse to Student List for "Highway Pursuit 100"
Consider student "3"
? Verify label for "Student Name" is "Doo, Dewbie"
Select student "Doo, Dewbie"
Delete enrollment

"Cancel a registration":
>use: Registration Management
Cancel registration for "Bradley, Blake" in "Highway Pursuit 101"

"Verify bill was created at enrollment":
>use: Billing Items Export Workflow
Export all billing items
? Verify there are "5" items

? Verify row #Num
    ? Verify "Event / Class*" is #EventName
    ? Verify "Bill To" is #BillName
    ? Verify "Cancelled" is #Cancelled

[ Num | Event name                    | BillName           | Cancelled ]
| 1   | Driving - Highway Pursuit 100 | "Bradley, Blake"   | Y         |
| 2   | Driving - Highway Pursuit 101 | "Bradley, Blake"   | Y         |
| 3   | Driving - Highway Pursuit 103 | "Nicholas, Jamila" | N         |
| 4   | Driving - Highway Pursuit 100 | "Chase, Charles"   | N         |
| 5   | Driving - Highway Pursuit 100 | "Doo, Dewbie"      | N         |


"Cancel a class":
>use: Edit Class Workflow
Browse to page to edit class "Highway Pursuit 100"
Select status "Cancelled"
Save Class
Confirm class cancellation

"Change billing to at registration":
>use: Billing Preferences Workflow
Browse to page
Click to edit category "Class"
Choose to track category
Choose to create billing information "At registration"
Choose to calculate billing as a variable fee
Choose "Individual" to be responsible for fees
Prepare to save preference
Click save preference

"Register Eady, Forrest":
>use: Register Student Workflow
Browse to page from available training list registering for "Highway Pursuit 100"
Select student "Eady, Forrest"
Select  "Individual" for Tuition Bill to Party
Click Register

"Register Johnson, Danny":
>use: Register Student Workflow
Browse to page from available training list registering for "Highway Pursuit 100"
Select student "Johnson, Danny"
Select "Individual" for Tuition Bill to Party
Click Register

"Change billing to at enrollment with flat fee":
>use: Billing Preferences Workflow
Browse to page
Click to edit category "Class"
Choose to track category
Choose to create billing information "At enrollment"
Choose to calculate billing as a flat fee
Enter "104.99" as a flat fee
Choose "Individual" to be responsible for fees
Prepare to save preference
Click save preference

"Enroll Worthen, Jorge directly":
>use: Add Enrollment Workflow
Browse to page for "Highway Pursuit 100"
Select "Worthen, Jorge" to enroll
Select  "Individual" for Tuition Bill to Party
Click Continue

"Enroll Murphy, Sam directly":
>use: Add Enrollment Workflow
Browse to page for "Highway Pursuit 100"
Select "Murphy, Sam" to enroll
Select  "Individual" for Tuition Bill to Party
Click Continue

"Enroll Brown, Wendell directly":
>use: Add Enrollment Workflow
Browse to page for "Highway Pursuit 101"
Select "Brown, Wendell" to enroll
Select "Individual" for Tuition Bill to Party
Click Continue

"Delete Registration for Eady, Forrest":
>use: Registration Management
Delete registration for "Eady, Forrest" in "Highway Pursuit 100"

"Move Brown, Wendell from enrolled to registered":
>use: Registration Management
Move "Brown, Wendell" in "Highway Pursuit 101" from enrolled to registered
? Verify "Brown, Wendell" is registered for class "Highway Pursuit 101"

"Delete Worthen, Jorge":
>use: Person Management
Delete person "Worthen, Jorge"

"Move Murphy, Sam and Johnson, Danny to waitlist":
>use: Registration Management
Move "Murphy, Sam" in "Highway Pursuit 100" to waitlist
? Verify "Murphy, Sam" is waitlisted for class "Highway Pursuit 100"
Move "Johnson, Danny" in "Highway Pursuit 100" to waitlist
? Verify "Johnson, Danny" is waitlisted for class "Highway Pursuit 100"

"Change billing to at enrollment with flat fee":
>use: Billing Preferences Workflow
Browse to page
Click to edit category "Class"
Choose to track category
Choose to create billing information "At registration"
Choose to calculate billing as a flat fee
Enter "200.00" as a flat fee
Choose "Individual" to be responsible for fees
Prepare to save preference
Click save preference

"Register person A":
>use: Register Student Workflow
Browse to page from available training list registering for "Highway Pursuit 100"
Select student "Fairchild, Florence"
Click Register

"Cancel a registration":
>use: Registration Management
Cancel registration for "Fairchild, Florence" in "Highway Pursuit 100"


"Verify  bill was created at enrollment":
>use: Billing Items Export Workflow
Export all billing items
? Verify there are "11" items

? Verify row #Num
    ? Verify "Category" is "Class"
    ? Verify "Bill Created At" is #BilledAt
    ? Verify "Event / Class*" is #ClassItem
    ? Verify "Billing Item" is #ClassItem
    ? Verify "Billing Usage" is blank
    ? Verify "Usage Period Start" is blank
    ? Verify "Usage Period End" is blank
    ? Verify "For" is #Name
    ? Verify "Date" is "01/01/2023"
    ? Verify "Bill To" is #Name
    ? Verify "Amount" is #Amount
    ? Verify "Cancelled" is "Y"
    ? Verify "Description" is "TUITION CHARGE for #Name (#ID): #ClassItem (occurring 01/01/2023 - 01/01/2023)"
    ? Verify "Quantity" is "1"
    ? Verify "Unit Price" is #Amount

[ Num | Name                  | ID | Billed At    | Class Item                    | Amount | Cancelled ]
|   1 | "Bradley, Blake"      | B1 | Registration | Driving - Highway Pursuit 100 | 101.42 | Y         |
|   2 | "Bradley, Blake"      | B1 | Registration | Driving - Highway Pursuit 101 | 131.45 | Y         |
|   3 | "Nicholas, Jamila"    | N1 | Enrollment   | Driving - Highway Pursuit 103 | 172.55 | N         |
|   4 | "Chase, Charles"      | C1 | Enrollment   | Driving - Highway Pursuit 100 |  99.99 | N         |
|   5 | "Doo, Dewbie"         | D1 | Enrollment   | Driving - Highway Pursuit 100 |  99.99 | N         |
|   6 | "Eady, Forrest"       | E2 | Registration | Driving - Highway Pursuit 100 | 101.42 | Y         |
|   7 | "Johnson, Danny"      | J1 | Registration | Driving - Highway Pursuit 100 | 101.42 | Y         |
|   8 | "Worthen, Jorge"      | W1 | Registration | Driving - Highway Pursuit 100 | 104.99 | Y         |
|   9 | "Murphy, Sam"         | M1 | Enrollment   | Driving - Highway Pursuit 100 | 104.99 | Y         |
|  10 | "Brown, Wendell"      | B2 | Enrollment   | Driving - Highway Pursuit 100 | 104.99 | Y         |
|  11 | "Fairchild, Florence" | F1 | Registration | Driving - Highway Pursuit 100 | 200    | Y         |


"Verify that cancellations are transmitted to an external accounting system":
>use: Accounting Api Workflow
Get cancellations
? Verify there are "10" cancellations

>use: Accounting Api Workflow
Begin verifying cancellation item #Num
    ? Verify cancellation date is "1/1/2023"
    ? Verify cancellation reason is #Reason
    ? Verify cancellation amount is Amount
    ? Verify cancellation bill date is "1/1/2023"
    ? Verify cancellation bill for is #Person
    ? Verify cancellation Bill To is #Person
    ? Verify cancellation category is "Class"
    ? Verify cancellation event is #Event
    ? Verify cancellation item is #Event
    ? Verify cancellation period start is blank
    ? Verify cancellation period end is blank
    ? Verify cancellation quantity is "1"
    ? Verify cancellation unit price is #Amount
    ? Verify cancellation usage is blank
    ? Verify cancellation description is #Description

[ Num | Reason                      | Amount | Person              | Event                         | Description ]
|  1  | Transfer to Different Class | 101.42 | Bradley, Blake      | Driving - Highway Pursuit 100 | TUITION CHARGE for Bradley, Blake (B1): Driving - Highway Pursuit 100 (occurring 01/01/2023 - 01/01/2023) |
|  2  | Deleted Enrollment          |  99.99 | Doo, Dewbie         | Driving - Highway Pursuit 100 | TUITION CHARGE for Doo, Dewbie (D1): Driving - Highway Pursuit 100 (occurring 01/01/2023 - 01/01/2023) |
|  3  | Cancelled Registration      | 131.45 | Bradley, Blake      | Driving - Highway Pursuit 101 | TUITION CHARGE for Bradley, Blake (B1): Driving - Highway Pursuit 101 (occurring 01/01/2023 - 01/01/2023) |
|  4  | Cancelled Class             |  99.99 | Chase, Charles      | Driving - Highway Pursuit 100 | TUITION CHARGE for Chase, Charles (C1): Driving - Highway Pursuit 100 (occurring 01/01/2023 - 01/01/2023) |
|  5  | Deleted Registration        | 101.42 | Eady, Forrest       | Driving - Highway Pursuit 100 | TUITION CHARGE for Eady, Forrest (E2): Driving - Highway Pursuit 100 (occurring 01/01/2023 - 01/01/2023) |
|  6  | Move to Pending             | 104.99 | Brown, Wendell      | Driving - Highway Pursuit 101 | TUITION CHARGE for Brown, Wendell (B2): Driving - Highway Pursuit 101 (occurring 01/01/2023 - 01/01/2023) |
|  7  | Deleted Person              | 104.99 | Worthen, Jorge      | Driving - Highway Pursuit 100 | TUITION CHARGE for Worthen, Jorge (W1): Driving - Highway Pursuit 100 (occurring 01/01/2023 - 01/01/2023) |
|  8  | Move to Waitlist            | 104.99 | Murphy, Sam         | Driving - Highway Pursuit 100 | TUITION CHARGE for Murphy, Sam (M1): Driving - Highway Pursuit 100 (occurring 01/01/2023 - 01/01/2023) |
|  9  | Move to Waitlist            | 101.42 | Johnson, Danny      | Driving - Highway Pursuit 100 | TUITION CHARGE for Johnson, Danny (J1): Driving - Highway Pursuit 100 (occurring 01/01/2023 - 01/01/2023) |
| 10  | Cancelled Registration      | 200.00 | Fairchild, Florence | Driving - Highway Pursuit 100 | TUITION CHARGE for Fairchild, Florence (F1): Driving - Highway Pursuit 100 (occurring 01/01/2023 - 01/01/2023) |
